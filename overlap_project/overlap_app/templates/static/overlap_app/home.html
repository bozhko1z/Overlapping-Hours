<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Overlap</title>
    {%load static%}
    <link rel="stylesheet" type="text/css" href="{%static 'overlap_app/style.css'%}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <h2 class="text-center mb-4">Check time overlap</h2>

        <form method="POST"  onsubmit="hiddenInp()">
            {% csrf_token %}

            <div class="p-3 mt-4 column" id="renSlot">
            </div>

            <div id="slots">
                <div class="slot border rounded p-3  mb-3 row">
                    <div class="mb-3 col-4">
                        <label for="days" class="form-label">Select Day</label>
                        <select name="day" id="days" class="form-select">
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                            <option value="Weekend">Weekend</option>
                            <option value="Working days">Working Days</option>
                            <option value="All days">All Days</option>
                        </select>
                    </div>

                    <div class="mb-3 col-4">
                        <label for="starts" class="form-label">Start Time</label>
                        <input type="text" name="start" id="starts" class="form-control" placeholder="e.g. 09:00">
                    </div>

                    <div class="mb-3 col-4">
                        <label for="ends" class="form-label">End Time</label>
                        <input type="text" name="end" id="ends" class="form-control" placeholder="e.g. 17:00">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary">Check Overlap</button>
                <button type="button" onclick="saveSlot()" class="btn btn-outline-secondary">Save Slot</button>
            </div>
        </form>


        <div id="message">
            {% if result is not None %}
                {% if result %}
                    <div class="alert alert-success">No Overlap Detected</div>
                {% else %}
                    <div class="alert alert-danger">Overlap Detected</div>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <script>
        const slots = []
        const currentSlot = document.querySelector('.slot');

            currentSlot.addEventListener('keydown', function (event){
                if(event.key === "Enter"){
                    event.preventDefault();
                    alert("ne natiskai, mimi");
                }
            });
        function hiddenInp(){
            const form = document.querySelector('form');

            document.querySelectorAll('.hidden-slot').forEach(e => e.remove());

            slots.forEach(slot => {
                ['day', 'start', 'end'].forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = slot[key];
                    input.classList.add('hidden-slot');
                    form.appendChild(input);
                });
            });
        }
        function saveSlot() {

            const dayInput = currentSlot.querySelector('select');
            const startInput = currentSlot.querySelector('input[name="start"]');
            const endInput = currentSlot.querySelector('input[name="end"]');

            const day = dayInput.value
            const start = startInput.value
            const end = endInput.value

            if(!day || !start || !end){
                alert("please fill in all the fields")
                return;
            }
            if (end < start){
                alert("invalid format, Aleks")
                return;
            }
            if(!start.includes(':') || !end.includes(':')){
                alert("invalid input")
                return;
            }

            slots.push({day, start, end})

            renderSlot()

            dayInput.selectedIndex = 0
            startInput.value = ''
            endInput.value = ''

        }

        function renderSlot(){
            const displayDiv = document.getElementById("renSlot");

            if (!displayDiv) return;

            displayDiv.innerHTML = "";

            slots.forEach((slot, index) => {
                const div = document.createElement("div");
                div.className = "mb-2";
                div.innerHTML = `Slot ${index + 1}: ${slot.day} ${slot.start} - ${slot.end}`;
                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.className = "btn btn-sm btn-danger ms-2";
                editBtn.onclick = () => editSlot(index);
                div.appendChild(editBtn)
                displayDiv.appendChild(div);
            });
        }

        function editSlot(index){
            const dayInput = currentSlot.querySelector('select[name="day"]');
            const startInput = currentSlot.querySelector('input[name="start"]');
            const endInput = currentSlot.querySelector('input[name="end"]');

            dayInput.value = slots[index].day;
            startInput.value = slots[index].start;
            endInput.value = slots[index].end;
            slots.splice(index, 1);

            renderSlot()
        }

    </script>

</body>
</html>
